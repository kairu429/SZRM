<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚µã‚¤ã‚¼ãƒªãƒ¤æ³¨æ–‡ã‚¹ãƒ­ãƒƒãƒˆ - ç©¶æ¥µç‰ˆ</title>
    
    <link rel="icon" type="image/png" href="https://github.com/kairu429/SZRM/blob/main/%E3%82%B5%E3%82%A4%E3%82%BC%E3%83%AA%E3%82%A2%E3%83%A9%E3%83%B3%E3%83%80%E3%83%9E%E3%82%A4%E3%82%BA.png?raw=true">
    <link rel="apple-touch-icon" href="https://github.com/kairu429/SZRM/blob/main/%E3%82%B5%E3%82%A4%E3%82%BC%E3%83%AA%E3%82%A2%E3%83%A9%E3%83%B3%E3%83%80%E3%83%9E%E3%82%A4%E3%82%BA.png?raw=true">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'saize-slot-app';

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
        window.db = db;
        window.auth = auth;
        window.appId = appId;
        window.firebaseStore = { doc, setDoc, getDoc, collection, query, onSnapshot, updateDoc, deleteDoc };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@700;800;900&display=swap');
        
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: #f7fafc;
            color: #2d3748;
            overflow-x: hidden;
        }

        .saize-card {
            background: white;
            border: 6px solid #009241;
            border-radius: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .slot-window {
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            border: 4px inset #edf2f7;
            margin: 15px 0;
            overflow: hidden;
            border-radius: 20px;
        }

        .spinning {
            animation: slot-spin 0.07s linear infinite;
        }

        @keyframes slot-spin {
            0% { transform: translateY(-20px); opacity: 0.3; }
            100% { transform: translateY(20px); opacity: 0.3; }
        }

        @keyframes rainbow-bg {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .rainbow-rank {
            background: linear-gradient(124deg, #ff2400, #e81d1d, #e8b71d, #e3e81d, #1de840, #1ddde8, #2b1de8, #dd00f3, #dd00f3);
            background-size: 800% 800%;
            animation: rainbow-bg 4s ease infinite;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 900;
        }

        .rainbow-border {
            background: linear-gradient(124deg, #ff2400, #e81d1d, #e8b71d, #e3e81d, #1de840, #1ddde8, #2b1de8, #dd00f3, #dd00f3);
            background-size: 400% 400%;
            animation: rainbow-bg 2s ease infinite;
            border: 4px solid transparent !important;
        }

        .btn-saize {
            background: linear-gradient(to bottom, #00b34d, #008037);
            box-shadow: 0 6px 0 #005a26;
            transition: all 0.1s ease;
        }
        .btn-saize:active:not(:disabled) {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #005a26;
        }
        .btn-saize:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 100;
            align-items: center; justify-content: center;
            backdrop-filter: blur(8px);
        }

        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 10px; }

        #notify {
            position: fixed;
            top: -100px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 350px;
            background: white; border-radius: 20px; padding: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: top 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1000;
        }
        #notify.show { top: 20px; }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <!-- ç§°å·é€šçŸ¥ -->
    <div id="notify" class="flex items-center">
        <div id="notify-icon" class="text-4xl mr-4">ğŸ†</div>
        <div>
            <div class="text-[10px] font-black text-green-600 tracking-tighter uppercase">ç§°å·ç²å¾—ï¼</div>
            <div id="notify-title" class="text-sm font-black">ã‚¿ã‚¤ãƒˆãƒ«</div>
        </div>
    </div>

    <div class="max-w-md w-full text-center">
        <header class="mb-8 flex flex-col items-center">
            <img src="https://github.com/kairu429/SZRM/blob/main/%E3%82%B5%E3%82%A4%E3%82%BC%E3%83%AA%E3%82%A2%E3%83%A9%E3%83%B3%E3%83%80%E3%83%9E%E3%82%A4%E3%82%BA.png?raw=true" alt="Logo" class="w-16 h-16 mb-2 rounded-xl shadow-md">
            <h1 class="text-4xl font-black text-red-600 drop-shadow-sm">ã‚µã‚¤ã‚¼ãƒªãƒ¤<span class="text-green-600">ã‚¬ãƒãƒ£</span></h1>
            
            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ è¡¨ç¤ºéƒ¨åˆ† -->
            <button id="user-name-btn" class="mt-2 flex items-center gap-1 bg-white/50 px-3 py-1 rounded-full border border-gray-200 hover:bg-white transition-all">
                <span id="user-display-name" class="text-xs font-black text-gray-700">ã‚²ã‚¹ãƒˆ</span>
                <span class="text-[10px] text-gray-400">âœï¸</span>
            </button>
            <div id="user-uid-display" class="text-[8px] text-gray-300 font-mono mt-1">ID: --------</div>
        </header>

        <div class="saize-card p-6 mb-6 relative">
            <div class="flex justify-between items-center mb-2">
                <span id="cat-label" class="bg-green-100 text-green-700 text-[10px] px-3 py-1 rounded-full font-black">CATEGORY</span>
                <button id="age-btn" class="bg-gray-800 text-white text-[10px] px-3 py-1 rounded-full font-black hover:bg-black">
                    å¹´é½¢: <span id="age-val">--</span>æ­³ âœï¸
                </button>
            </div>

            <div class="slot-window">
                <div id="menu-name" class="text-2xl font-black px-2 leading-tight">ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ</div>
            </div>

            <div class="flex justify-between items-end mt-4">
                <div class="text-left">
                    <div class="text-[10px] text-gray-400 font-bold">Menu No.</div>
                    <div id="menu-id" class="text-xl font-black text-green-600">----</div>
                </div>
                <div class="text-right">
                    <div class="text-[10px] text-gray-400 font-bold">Price</div>
                    <div id="menu-price" class="text-3xl font-black text-red-600">Â¥ ---</div>
                </div>
            </div>
        </div>

        <button id="spin-btn" disabled class="btn-saize w-full py-5 rounded-2xl text-white text-2xl font-black mb-6">
            æº–å‚™ä¸­...
        </button>

        <div class="grid grid-cols-2 gap-4 text-xs font-black text-gray-500">
            <div class="bg-white p-2 rounded-xl border shadow-sm">ç™ºè¦‹: <span id="stat-collected">0</span></div>
            <div class="bg-white p-2 rounded-xl border shadow-sm">å›æ•°: <span id="stat-spins">0</span></div>
        </div>
    </div>

    <!-- ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
    <div class="fixed bottom-6 w-full max-w-md px-6 flex justify-between items-center pointer-events-auto">
        <button id="open-admin" class="w-14 h-14 bg-gray-900 text-white rounded-2xl shadow-xl flex items-center justify-center text-2xl hover:scale-110 transition-all">âš™ï¸</button>
        <button id="open-ranking" class="w-14 h-14 bg-yellow-500 text-white rounded-2xl shadow-xl flex items-center justify-center text-2xl hover:scale-110 transition-all">ğŸ†</button>
        <button id="open-book" class="w-18 h-18 bg-white border-4 border-green-600 rounded-3xl shadow-xl flex items-center justify-center text-4xl p-4 hover:scale-110 transition-all">ğŸ“–</button>
    </div>

    <!-- åå‰è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="name-modal" class="modal-overlay">
        <div class="bg-white p-8 rounded-[40px] w-full max-w-xs text-center shadow-2xl">
            <div class="text-6xl mb-4">ğŸ·ï¸</div>
            <h2 class="text-2xl font-black mb-2">ãƒ¦ãƒ¼ã‚¶ãƒ¼åå¤‰æ›´</h2>
            <input type="text" id="name-input" maxlength="15" class="w-full text-center text-xl font-black border-b-4 border-gray-100 focus:border-green-500 outline-none mb-8" placeholder="ãªã¾ãˆ">
            <button id="name-save" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl text-xl hover:bg-blue-700 transition-all">ä¿å­˜</button>
        </div>
    </div>

    <!-- å¹´é½¢è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="age-modal" class="modal-overlay">
        <div class="bg-white p-8 rounded-[40px] w-full max-w-xs text-center shadow-2xl">
            <div class="text-6xl mb-4">ğŸ</div>
            <h2 class="text-2xl font-black mb-2">ä½•æ­³ã§ã™ã‹ï¼Ÿ</h2>
            <input type="number" id="age-input" class="w-full text-center text-4xl font-black border-b-4 border-gray-100 focus:border-green-500 outline-none mb-8" placeholder="20">
            <button id="age-save" class="w-full bg-green-600 text-white font-black py-4 rounded-2xl text-xl hover:bg-green-700 transition-all">æ±ºå®š</button>
        </div>
    </div>

    <!-- ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="admin-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-sm rounded-[40px] p-6 shadow-2xl">
            <h2 class="text-xl font-black mb-4 flex items-center gap-2">âš™ï¸ ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
            
            <div id="menu-editor" class="hidden space-y-4 mb-6 p-4 bg-green-50 rounded-2xl border-2 border-dashed border-green-200">
                <p class="text-[10px] font-black text-green-600">ğŸ‘‘ ç‹æ§˜å°‚ç”¨: ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¿½åŠ </p>
                <input id="new-menu-name" placeholder="ãƒ¡ãƒ‹ãƒ¥ãƒ¼å" class="w-full p-2 border rounded-lg text-sm">
                <div class="flex gap-2">
                    <input id="new-menu-price" type="number" placeholder="ä¾¡æ ¼" class="w-1/2 p-2 border rounded-lg text-sm">
                    <select id="new-menu-cat" class="w-1/2 p-2 border rounded-lg text-sm">
                        <option>ã‚µãƒ©ãƒ€</option><option>ã‚¹ãƒ¼ãƒ—</option><option>å‰èœ</option>
                        <option>ãƒ‰ãƒªã‚¢</option><option>ãƒ”ã‚¶</option><option>ãƒ‘ã‚¹ã‚¿</option>
                        <option>è‚‰æ–™ç†</option><option>ãƒ‡ã‚¶ãƒ¼ãƒˆ</option><option>ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«</option>
                    </select>
                </div>
                <button id="add-menu-btn" class="w-full bg-green-600 text-white font-black py-2 rounded-xl text-sm">æ–°è¦è¿½åŠ </button>
            </div>

            <div class="space-y-3">
                <button id="reset-data" class="w-full bg-red-100 text-red-600 font-black py-3 rounded-2xl text-sm border-2 border-red-200">å…¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</button>
                <button class="close-btn w-full bg-gray-100 text-gray-500 font-black py-3 rounded-2xl text-sm">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="ranking-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-lg rounded-[40px] overflow-hidden flex flex-col h-[80vh] shadow-2xl">
            <div class="bg-yellow-500 p-4 flex justify-between items-center text-white">
                <span class="font-black">ğŸ† å…¨å›½ã‚µã‚¤ã‚¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°</span>
                <button class="close-btn text-2xl">&times;</button>
            </div>
            <div id="ranking-list" class="flex-1 overflow-y-auto p-4 space-y-2 custom-scroll">
                <!-- Rankings injected here -->
            </div>
        </div>
    </div>

    <!-- å›³é‘‘ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="book-modal" class="modal-overlay">
        <div class="bg-white w-full max-w-lg rounded-[40px] overflow-hidden flex flex-col h-[85vh] shadow-2xl">
            <div class="bg-green-600 p-4 flex justify-around items-center">
                <button id="tab-menu" class="text-white font-black text-sm px-4 py-2 bg-white/20 rounded-full">ãƒ¡ãƒ‹ãƒ¥ãƒ¼å›³é‘‘</button>
                <button id="tab-trophy" class="text-white font-black text-sm px-4 py-2 opacity-60 rounded-full">ç§°å·ãƒˆãƒ­ãƒ•ã‚£ãƒ¼</button>
                <button class="close-btn text-white text-3xl font-light">&times;</button>
            </div>
            
            <div id="content-menu" class="flex-1 overflow-y-auto p-6 custom-scroll">
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-black text-gray-400">PROGRESS</span>
                        <span id="prog-text" class="text-sm font-black text-green-700">0/0</span>
                    </div>
                    <div class="w-full h-4 bg-gray-100 rounded-full overflow-hidden">
                        <div id="prog-bar" class="h-full bg-green-500 transition-all duration-1000"></div>
                    </div>
                </div>
                <div id="menu-list" class="space-y-3"></div>
            </div>

            <div id="content-trophy" class="hidden flex-1 overflow-y-auto p-6 custom-scroll bg-gray-50">
                <div id="trophy-list" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { doc, setDoc, getDoc, collection, query, onSnapshot, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Constants for Random Name Generation
        const ADJECTIVES = ["æŠ—èŒãª", "ãƒãƒ‹ã‚¢ãƒƒã‚¯ãª", "ãƒ­ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãª", "æ™®é€šãª", "å°‘ã—å¤‰ã‚ã£ãŸ", "äººæ°—è€…ãª"];
        const JOBS = ["ã‚µã‚¤ã‚¼ãƒªã‚¢ãƒãƒ‹ã‚¢", "äºº", "ãƒãƒƒãƒˆãƒŸãƒ¼ãƒ ", "ãƒ©ãƒƒãƒ‘ãƒ¼", "å…ƒæ°—å±‹ã•ã‚“"];

        const generateRandomName = () => {
            const adj = ADJECTIVES[Math.floor(Math.random() * ADJECTIVES.length)];
            const job = JOBS[Math.floor(Math.random() * JOBS.length)];
            const num = Math.floor(Math.random() * 9999).toString().padStart(4, '0');
            return `${adj}${job}${num}`;
        };

        const INITIAL_MENU = [
            { id: "1202", name: "å°ã‚¨ãƒ“ã®ã‚µãƒ©ãƒ€", price: 350, cat: "ã‚µãƒ©ãƒ€" },
            { id: "1205", name: "ã‚ã‹ã‚ã®ã‚µãƒ©ãƒ€", price: 350, cat: "ã‚µãƒ©ãƒ€" },
            { id: "1207", name: "ãƒ¢ãƒƒãƒ„ã‚¡ãƒ¬ãƒ©ã®ã‚µãƒ©ãƒ€", price: 400, cat: "ã‚µãƒ©ãƒ€" },
            { id: "1301", name: "ã‚³ãƒ¼ãƒ³ã‚¯ãƒªãƒ¼ãƒ ã‚¹ãƒ¼ãƒ—", price: 150, cat: "ã‚¹ãƒ¼ãƒ—" },
            { id: "1401", name: "è¾›å‘³ãƒã‚­ãƒ³", price: 300, cat: "å‰èœ" },
            { id: "1405", name: "ã‚¨ã‚¹ã‚«ãƒ«ã‚´ã®ã‚ªãƒ¼ãƒ–ãƒ³ç„¼ã", price: 400, cat: "å‰èœ" },
            { id: "2101", name: "ãƒŸãƒ©ãƒé¢¨ãƒ‰ãƒªã‚¢", price: 300, cat: "ãƒ‰ãƒªã‚¢" },
            { id: "2203", name: "ãƒãƒ«ã‚²ãƒªãƒ¼ã‚¿ãƒ”ã‚¶", price: 400, cat: "ãƒ”ã‚¶" },
            { id: "2303", name: "ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ", price: 300, cat: "ãƒ‘ã‚¹ã‚¿" },
            { id: "2305", name: "ã‚«ãƒ«ãƒœãƒŠãƒ¼ãƒ©", price: 500, cat: "ãƒ‘ã‚¹ã‚¿" },
            { id: "3206", name: "ã‚¤ã‚¿ãƒªã‚¢ãƒ³ãƒ—ãƒªãƒ³", price: 250, cat: "ãƒ‡ã‚¶ãƒ¼ãƒˆ" },
            { id: "3301", name: "ç”Ÿãƒ“ãƒ¼ãƒ«(ã‚¸ãƒ§ãƒƒã‚­)", price: 400, cat: "ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«" },
            { id: "3401", name: "ã‚°ãƒ©ã‚¹ãƒ¯ã‚¤ãƒ³(èµ¤)", price: 100, cat: "ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«" }
        ];

        let menuMaster = [...INITIAL_MENU];
        let state = {
            displayName: localStorage.getItem('saize_user_name') || generateRandomName(),
            age: null,
            spins: 0,
            collected: [],
            totalPrice: 0,
            unlockedTrophies: []
        };
        let currentUser = null;

        // Save initial random name to localStorage if not exists
        if (!localStorage.getItem('saize_user_name')) {
            localStorage.setItem('saize_user_name', state.displayName);
        }

        const TROPHIES = Array.from({length: 100}, (_, i) => {
            const id = i + 1;
            if (id === 1) return { id, name: "ã¯ã˜ã‚ã¦ã®å®¢", condition: "1å›æ³¨æ–‡ã™ã‚‹", check: s => s.spins >= 1, icon: "ğŸ‘¤" };
            if (id === 2) return { id, name: "ã‚µãƒ©ãƒ€é€š", condition: "ã‚µãƒ©ãƒ€ã‚’3ç¨®é¡ç™ºè¦‹", check: s => s.collected.filter(mid => menuMaster.find(m => m.id === mid)?.cat === "ã‚µãƒ©ãƒ€").length >= 3, icon: "ğŸ¥—" };
            if (id === 10) return { id, name: "å¸¸é€£ã•ã‚“", condition: "ç´¯è¨ˆ30å›ä»¥ä¸Šæ³¨æ–‡", check: s => s.spins >= 30, icon: "ğŸ«" };
            if (id === 100) return { id, name: "ã•ã„ãœã‚Šã‚ã®ç‹æ§˜", condition: "å…¨ã¦ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆ", check: s => {
                const active = s.age < 20 ? menuMaster.filter(m => m.cat !== "ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«") : menuMaster;
                return active.length > 0 && active.every(m => s.collected.includes(m.id));
            }, icon: "ğŸ‘‘", isRainbow: true };
            return { id, name: `ç†Ÿç·´ã®å®¢ Lv.${id}`, condition: `ç´¯è¨ˆ ${id * 2}å›`, check: s => s.spins >= id * 2, icon: "ğŸ–ï¸" };
        });

        const init = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(window.auth, __initial_auth_token);
                } else {
                    await signInAnonymously(window.auth);
                }
            } catch (err) {
                console.error("Auth failed:", err);
            }

            onAuthStateChanged(window.auth, async (user) => {
                if (user) {
                    currentUser = user;
                    document.getElementById('user-uid-display').innerText = `ID: ${user.uid.substring(0, 10)}...`;
                    document.getElementById('spin-btn').disabled = false;
                    document.getElementById('spin-btn').innerText = "æ³¨æ–‡ã‚’æ±ºã‚ã‚‹ï¼";
                    
                    await loadUserData();
                    startSyncing();
                }
            });
        };

        const startSyncing = () => {
            if (!currentUser) return;
            syncMenuMaster();
            syncRankings();
        };

        const loadUserData = async () => {
            if (!currentUser) return;
            try {
                const docRef = doc(window.db, 'artifacts', window.appId, 'users', currentUser.uid, 'profile', 'state');
                const snap = await getDoc(docRef);
                if (snap.exists()) {
                    const cloudData = snap.data();
                    // Merge cloud data with local displayName preference if local is newer or cloud is missing
                    state = { ...state, ...cloudData };
                    // If cloud has a name, update local storage too
                    if (state.displayName) {
                        localStorage.setItem('saize_user_name', state.displayName);
                    }
                }
                updateStats();
                if (!state.age) document.getElementById('age-modal').style.display = 'flex';
            } catch (err) {
                console.error("Load state error:", err);
            }
        };

        const saveUserData = async () => {
            if (!currentUser) return;
            try {
                const docRef = doc(window.db, 'artifacts', window.appId, 'users', currentUser.uid, 'profile', 'state');
                await setDoc(docRef, state);
                
                const publicRef = doc(window.db, 'artifacts', window.appId, 'public', 'data', 'rankings', currentUser.uid);
                await setDoc(publicRef, {
                    uid: currentUser.uid,
                    displayName: state.displayName,
                    spins: state.spins,
                    collectedCount: state.collected.length,
                    updatedAt: Date.now()
                });
            } catch (err) {
                console.error("Save state error:", err);
            }
        };

        const syncMenuMaster = () => {
            if (!currentUser) return;
            const menuCol = collection(window.db, 'artifacts', window.appId, 'public', 'data', 'menu');
            onSnapshot(menuCol, (snap) => {
                const cloudMenu = snap.docs.map(d => d.data());
                if (cloudMenu.length > 0) menuMaster = cloudMenu;
                checkAdminStatus();
            }, (err) => console.error("Menu sync error:", err));
        };

        const syncRankings = () => {
            if (!currentUser) return;
            const rankCol = collection(window.db, 'artifacts', window.appId, 'public', 'data', 'rankings');
            onSnapshot(rankCol, (snap) => {
                const raw = snap.docs.map(d => d.data());
                const sorted = raw.sort((a, b) => (b.spins + b.collectedCount * 10) - (a.spins + a.collectedCount * 10)).slice(0, 20);
                const list = document.getElementById('ranking-list');
                list.innerHTML = sorted.map((r, i) => `
                    <div class="flex items-center justify-between p-3 bg-white rounded-xl border shadow-sm ${r.uid === currentUser.uid ? 'border-green-500 bg-green-50' : ''}">
                        <div class="flex items-center gap-3">
                            <span class="text-lg font-black text-gray-400 w-6">${i+1}</span>
                            <div>
                                <div class="text-[10px] font-black text-gray-800">${r.displayName || 'ã‚²ã‚¹ãƒˆ'}</div>
                                <div class="text-[7px] text-gray-300 font-mono">${r.uid.substring(0, 8)}</div>
                            </div>
                        </div>
                        <div class="flex gap-4">
                            <div class="text-right"><div class="text-[8px] text-gray-400">æ³¨æ–‡</div><div class="font-black">${r.spins}</div></div>
                            <div class="text-right"><div class="text-[8px] text-gray-400">å›³é‘‘</div><div class="font-black">${r.collectedCount}</div></div>
                        </div>
                    </div>
                `).join('');
            }, (err) => console.error("Ranking sync error:", err));
        };

        const checkAdminStatus = () => {
            const isKing = state.unlockedTrophies.includes(100);
            document.getElementById('menu-editor').style.display = isKing ? 'block' : 'none';
        };

        const updateStats = () => {
            document.getElementById('stat-collected').innerText = state.collected.length;
            document.getElementById('stat-spins').innerText = state.spins;
            document.getElementById('age-val').innerText = state.age || "--";
            document.getElementById('user-display-name').innerText = state.displayName;
            checkAdminStatus();
        };

        const spin = () => {
            if (!currentUser || document.getElementById('spin-btn').disabled) return;
            const btn = document.getElementById('spin-btn');
            const display = document.getElementById('menu-name');
            btn.disabled = true;
            display.classList.add('spinning');

            const pool = state.age < 20 ? menuMaster.filter(m => m.cat !== "ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«") : menuMaster;
            if (pool.length === 0) {
                display.innerText = "ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãªã—";
                btn.disabled = false;
                return;
            }

            let count = 0;
            const iv = setInterval(() => {
                display.innerText = pool[Math.floor(Math.random() * pool.length)].name;
                if (++count > 25) {
                    clearInterval(iv);
                    display.classList.remove('spinning');
                    const result = pool[Math.floor(Math.random() * pool.length)];
                    display.innerText = result.name;
                    document.getElementById('menu-id').innerText = result.id;
                    document.getElementById('menu-price').innerText = "Â¥ " + result.price;
                    document.getElementById('cat-label').innerText = result.cat;

                    if (!state.collected.includes(result.id)) state.collected.push(result.id);
                    state.spins++;
                    state.totalPrice += result.price;
                    
                    saveUserData();
                    updateStats();
                    checkTrophies();
                    btn.disabled = false;
                }
            }, 60);
        };

        const checkTrophies = () => {
            TROPHIES.forEach(t => {
                if (!state.unlockedTrophies.includes(t.id) && t.check(state)) {
                    state.unlockedTrophies.push(t.id);
                    const n = document.getElementById('notify');
                    document.getElementById('notify-title').innerText = t.name;
                    document.getElementById('notify-icon').innerText = t.icon;
                    n.classList.add('show');
                    setTimeout(() => n.classList.remove('show'), 4000);
                    saveUserData();
                }
            });
        };

        // Name Modal Events
        document.getElementById('user-name-btn').onclick = () => {
            document.getElementById('name-input').value = state.displayName;
            document.getElementById('name-modal').style.display = 'flex';
        };

        document.getElementById('name-save').onclick = () => {
            const newName = document.getElementById('name-input').value.trim();
            if (newName) {
                state.displayName = newName;
                localStorage.setItem('saize_user_name', newName);
                saveUserData();
                updateStats();
                document.getElementById('name-modal').style.display = 'none';
            }
        };

        // Age Modal Events
        document.getElementById('age-save').onclick = () => {
            const age = parseInt(document.getElementById('age-input').value);
            if (age > 0) {
                state.age = age;
                saveUserData();
                updateStats();
                document.getElementById('age-modal').style.display = 'none';
            }
        };

        // UI Events
        document.getElementById('spin-btn').onclick = spin;
        document.getElementById('open-admin').onclick = () => document.getElementById('admin-modal').style.display = 'flex';
        document.getElementById('open-ranking').onclick = () => document.getElementById('ranking-modal').style.display = 'flex';
        document.getElementById('open-book').onclick = () => {
            document.getElementById('book-modal').style.display = 'flex';
            renderBook();
        };

        const renderBook = () => {
            const list = document.getElementById('menu-list');
            list.innerHTML = '';
            const pool = state.age < 20 ? menuMaster.filter(m => m.cat !== "ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«") : menuMaster;
            const isKing = state.unlockedTrophies.includes(100);

            menuMaster.sort((a,b) => a.id - b.id).forEach(m => {
                const isFound = state.collected.includes(m.id);
                const item = document.createElement('div');
                item.className = `p-4 rounded-2xl border-2 flex justify-between items-center ${isFound ? 'bg-white border-green-200' : 'bg-gray-100 opacity-40 grayscale'}`;
                item.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-[9px] font-black text-gray-300 mr-3">#${m.id}</span>
                        <div>
                            <div class="text-[8px] text-green-600 font-black uppercase">${m.cat}</div>
                            <div class="text-sm font-black text-gray-800">${isFound ? m.name : 'ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ'}</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="text-red-500 font-black">${isFound ? 'Â¥'+m.price : '---'}</div>
                        ${isKing ? `<button class="del-btn p-2 text-gray-300 hover:text-red-500 transition-colors" data-id="${m.id}">ğŸ—‘ï¸</button>` : ''}
                    </div>
                `;
                list.appendChild(item);
            });
            
            list.querySelectorAll('.del-btn').forEach(btn => {
                btn.onclick = async (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    if (confirm(`ãƒ¡ãƒ‹ãƒ¥ãƒ¼ #${id} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                        await deleteDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'menu', id));
                    }
                };
            });

            document.getElementById('prog-text').innerText = `${state.collected.length} / ${pool.length}`;
            document.getElementById('prog-bar').style.width = (state.collected.length / (pool.length || 1) * 100) + '%';
        };

        document.getElementById('add-menu-btn').onclick = async () => {
            const name = document.getElementById('new-menu-name').value;
            const price = parseInt(document.getElementById('new-menu-price').value);
            const cat = document.getElementById('new-menu-cat').value;
            if (!name || isNaN(price)) return;
            const id = Math.floor(1000 + Math.random() * 9000).toString();
            await setDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', 'menu', id), { id, name, price, cat });
            document.getElementById('new-menu-name').value = '';
            document.getElementById('new-menu-price').value = '';
        };

        document.getElementById('reset-data').onclick = async () => {
            if (confirm("ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã™ã€‚ç‹æ§˜ã®æ¨©é™ã‚‚å¤±ã‚ã‚Œã¾ã™ãŒã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) {
                localStorage.removeItem('saize_user_name');
                state = { displayName: generateRandomName(), age: null, spins: 0, collected: [], totalPrice: 0, unlockedTrophies: [] };
                localStorage.setItem('saize_user_name', state.displayName);
                await saveUserData();
                location.reload();
            }
        };

        // Tabs
        document.getElementById('tab-menu').onclick = () => {
            document.getElementById('content-menu').classList.remove('hidden');
            document.getElementById('content-trophy').classList.add('hidden');
            document.getElementById('tab-menu').classList.remove('opacity-60');
            document.getElementById('tab-trophy').classList.add('opacity-60');
        };
        document.getElementById('tab-trophy').onclick = () => {
            document.getElementById('content-menu').classList.add('hidden');
            document.getElementById('content-trophy').classList.remove('hidden');
            document.getElementById('tab-menu').classList.add('opacity-60');
            document.getElementById('tab-trophy').classList.remove('opacity-60');
            renderTrophies();
        };

        const renderTrophies = () => {
            const list = document.getElementById('trophy-list');
            list.innerHTML = TROPHIES.map(t => {
                const isUnlocked = state.unlockedTrophies.includes(t.id);
                return `
                    <div class="p-5 rounded-3xl border-2 flex items-center bg-white ${isUnlocked ? 'border-yellow-200 shadow-sm' : 'bg-gray-50 opacity-50'} ${t.isRainbow && isUnlocked ? 'rainbow-border' : ''}">
                        <div class="text-4xl mr-5">${isUnlocked ? t.icon : 'ğŸ”’'}</div>
                        <div class="flex-1">
                            <div class="text-[8px] text-gray-400">Achievement #${t.id}</div>
                            <div class="text-sm font-black ${t.isRainbow && isUnlocked ? 'rainbow-rank' : ''}">${t.name}</div>
                            <div class="text-[10px] text-gray-500">${t.condition}</div>
                        </div>
                    </div>
                `;
            }).join('');
        };

        document.querySelectorAll('.close-btn').forEach(b => b.onclick = () => {
            document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
        });

        init();
    </script>
</body>
</html>
